<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor METAR/SPECI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap');

        :root {
            --primary-color: #0f172a;
            --primary-light: #1e293b;
            --secondary-color: #3b82f6;
            --accent-color: #06b6d4;
            --background-color: #f8fafc;
            --background-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --text-color: #1e293b;
            --text-muted: #64748b;
            --alert-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --border-radius: 16px;
            --border-radius-sm: 8px;
            --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --box-shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            line-height: 1.6; 
            color: var(--text-color); 
            background: var(--background-gradient);
            padding: 24px;
            min-height: 100vh;
        }
        
        .audio-unlock-prompt {
            position: fixed; top: 0; left: 0; width: 100%;
            background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%);
            color: white; text-align: center; padding: 12px; z-index: 1000;
            font-weight: 600; box-shadow: var(--box-shadow);
        }
        
        header { 
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white; padding: 32px; border-radius: var(--border-radius); 
            margin-bottom: 32px; text-align: center; box-shadow: var(--box-shadow-lg);
            position: relative; overflow: hidden;
            margin-top: 50px; 
        }
        
        header::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(45deg, rgba(59, 130, 246, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
            pointer-events: none;
        }
        
        header h1 { font-size: 2.5rem; font-weight: 700; }
        header h2 { font-size: 1.25rem; font-weight: 400; opacity: 0.9; }
        
        .container, .historical-search-container { max-width: 1400px; margin: 0 auto; }
        .container { display: grid; grid-template-columns: 1fr; gap: 24px; }
        
        @media (min-width: 768px) { .container { grid-template-columns: 2fr 1fr; } }
        
        .card { 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            border-radius: var(--border-radius); padding: 24px; box-shadow: var(--box-shadow);
            border: 1px solid rgba(255, 255, 255, 0.2); transition: var(--transition);
        }
        
        .card:hover { transform: translateY(-2px); box-shadow: var(--box-shadow-lg); }
        
        .status-panel { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px; margin-bottom: 24px; padding: 20px;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-radius: var(--border-radius-sm);
        }
        
        .status-item { display: flex; align-items: center; gap: 12px; }
        .status-icon { width: 12px; height: 12px; border-radius: 50%; }
        .status-normal { background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%); }
        .status-warning { background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%); }
        .status-error { background: linear-gradient(135deg, var(--alert-color) 0%, #dc2626 100%); }
        
        .metar-display { 
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 24px; border-radius: var(--border-radius-sm); 
            font-family: 'JetBrains Mono', monospace; white-space: pre-wrap; word-break: break-word; 
            margin-bottom: 16px; min-height: 120px; border: 2px solid rgba(59, 130, 246, 0.1);
            font-size: 1.25rem; font-weight: 500;
        }
        
        .metar-time { font-size: 0.875rem; color: var(--text-muted); margin-bottom: 24px; }
        
        .alert-panel { 
            background: linear-gradient(135deg, var(--alert-color) 0%, #dc2626 100%);
            color: white; padding: 20px; border-radius: var(--border-radius-sm); 
            margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;
        }
        
        .alert-panel button { 
            background: rgba(255, 255, 255, 0.9); color: var(--alert-color); 
            border: none; padding: 10px 20px; border-radius: var(--border-radius-sm); cursor: pointer;
        }
        
        .history-panel h3, .settings-panel h3 { margin-bottom: 20px; font-size: 1.25rem; }
        
        .history-item { padding: 16px; border-bottom: 1px solid rgba(148, 163, 184, 0.2); }
        .history-item:last-child { border-bottom: none; }
        .history-metar { font-family: 'JetBrains Mono', monospace; font-size: 0.875rem; }
        .history-time { font-size: 0.75rem; color: var(--text-muted); }
        
        .settings-panel { margin-top: 24px; }
        .settings-container { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .setting { display: flex; align-items: center; gap: 16px; padding: 16px; }
        .setting label { font-weight: 500; min-width: 140px; }
        .setting input[type="text"] { padding: 8px 12px; border: 2px solid rgba(148, 163, 184, 0.3); border-radius: var(--border-radius-sm); }
        .setting input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--secondary-color); }
        .setting button { padding: 8px 16px; background: linear-gradient(135deg, var(--secondary-color) 0%, #2563eb 100%); color: white; border: none; border-radius: var(--border-radius-sm); cursor: pointer; }
        
        .historical-search { margin-top: 32px; }
        .search-controls { display: flex; flex-wrap: wrap; gap: 24px; align-items: center; }
        .search-controls input[type="text"], .search-controls input[type="date"], .search-controls input[type="month"] { padding: 10px; border: 2px solid rgba(148, 163, 184, 0.3); border-radius: var(--border-radius-sm); font-size: 1rem; }
        .search-controls button { padding: 10px 20px; font-size: 1rem; background: var(--primary-color); color: white; border: none; border-radius: var(--border-radius-sm); cursor: pointer; transition: var(--transition); }
        .search-controls button:hover { background: var(--primary-light); }
        .search-controls button:disabled { background: var(--text-muted); cursor: not-allowed; }
        #historicalSearchStatus { margin-top: 16px; font-weight: 500; }
        .search-type-selector, .search-filter { margin-bottom: 16px; display: flex; gap: 16px; align-items: center; font-weight: 500;}
        .hidden { display: none; }

        footer { margin-top: 48px; text-align: center; color: var(--text-muted); }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: white; border-radius: var(--border-radius);
            padding: 32px; box-shadow: var(--box-shadow-lg);
            width: 90%; max-width: 600px;
            transform: translateY(20px); transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-header h3 { font-size: 1.5rem; color: var(--primary-color); }
        .modal-close-btn { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text-muted); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .stat-card { background: #f8fafc; padding: 20px; border-radius: var(--border-radius-sm); text-align: center; border: 1px solid #e2e8f0; }
        .stat-card h4 { font-size: 1rem; color: var(--text-muted); margin-bottom: 8px; }
        .stat-card .value { font-size: 1.75rem; font-weight: 700; color: var(--primary-color); }
        .stat-card .percentage { font-size: 0.875rem; color: var(--secondary-color); }
        .modal-actions { display: flex; gap: 16px; justify-content: flex-end; }
        .modal-actions button { padding: 10px 20px; }
    </style>
</head>
<body>
    <div id="audioUnlockPrompt" class="audio-unlock-prompt">Clique em qualquer lugar da página para habilitar o som do alarme.</div>
    <header>
        <h1>Monitor METAR/SPECI</h1>
        <h2 id="aerodromoHeader">Aeroporto de SBIZ</h2>
    </header>
    
    <div class="container">
        <div class="main-content">
            <div class="card">
                <div class="status-panel">
                    <div class="status-item"><div id="statusIcon" class="status-icon status-normal"></div><span>Status: <strong id="statusValue">Iniciando...</strong></span></div>
                    <div class="status-item"><span>Última verificação: <strong id="lastCheckTime">--:--:--</strong></span></div>
                    <div class="status-item"><span>Próxima verificação: <strong id="nextCheckTime">--:--:--</strong></span></div>
                    <div class="status-item"><span>Tempo para próxima hora: <strong id="countdown">--:--</strong></span></div>
                </div>
                <div id="alertPanel" class="alert-panel" style="display: none;">
                    <div id="alertMessage">ALERTA: METAR/SPECI DA HORA NÃO ENCONTRADO!</div>
                    <button id="silenceButton">Silenciar</button>
                </div>
                <h3>ÚLTIMO METAR/SPECI RECEBIDO</h3>
                <div id="metarRaw" class="metar-display">Aguardando dados...</div>
                <div id="metarTime" class="metar-time"></div>
            </div>
            <div class="card settings-panel">
                <h3>Configurações</h3>
                <div class="settings-container">
                     <div class="setting">
                        <label for="aerodromoInput">Código ICAO:</label>
                        <input type="text" id="aerodromoInput" value="SBIZ" maxlength="4" style="text-transform: uppercase; width: 80px;">
                        <button id="alterarAerodromo">Alterar</button>
                    </div>
                    <div class="setting">
                        <label for="volumeControl">Volume do Alarme:</label>
                        <input type="range" id="volumeControl" min="0" max="1" step="0.1" value="0.7">
                    </div>
                    <div class="setting">
                        <label for="autoRefresh">Atualização Automática:</label>
                        <input type="checkbox" id="autoRefresh" checked>
                    </div>
                    <div class="setting">
                        <label>Análise de Dados:</label>
                        <button id="openAnalysisModal">Analisar Dados de Recebimento</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="sidebar">
            <div class="card history-panel">
                <h3>Histórico de Mensagens</h3>
                <div id="historyContainer"><p class="no-history">Nenhum histórico disponível</p></div>
            </div>
        </div>
    </div>

    <div class="historical-search-container">
        <div class="card historical-search">
            <h3>Busca Histórica e Relatórios</h3>
            
            <div class="search-type-selector">
                <strong>Tipo de Busca:</strong>
                <label><input type="radio" name="searchType" value="daily" id="radioDiario" checked> Diário</label>
                <label><input type="radio" name="searchType" value="monthly" id="radioMensal"> Mensal</label>
            </div>

             <div class="search-filter">
                <label><input type="checkbox" id="filterInconsistent"> Gerar somente com mensagens inconsistentes</label>
            </div>

            <div class="search-controls">
                <label for="historicalAerodromoInput">Código ICAO:</label>
                <input type="text" id="historicalAerodromoInput" maxlength="4" style="text-transform: uppercase; width: 100px;">
                
                <div id="dailyInputContainer">
                    <label for="historicalDateInput">Data:</label>
                    <input type="date" id="historicalDateInput">
                </div>
                
                <div id="monthlyInputContainer" class="hidden">
                    <label for="historicalMonthInput">Mês/Ano:</label>
                    <input type="month" id="historicalMonthInput">
                </div>
                
                <button id="generateHistoricalReportBtn">Gerar Relatório</button>
            </div>
            <p id="historicalSearchStatus"></p>
        </div>
    </div>

    <footer>
        <p id="footerText">Desenvolvido para monitoramento de METAR/SPECI - SBIZ - 2025</p>
    </footer>

    <div id="analysisModal" class="modal-overlay">
         <div class="modal-content">
            <div class="modal-header">
                <h3>Análise de Tempo de Recebimento</h3>
                <button id="closeAnalysisModal" class="modal-close-btn">&times;</button>
            </div>
            <div id="statsContainer" class="stats-grid"></div>
            <div class="modal-actions">
                <button id="exportCsvBtn">Baixar CSV</button>
                <button id="exportPdfBtn">Baixar PDF</button>
            </div>
        </div>
    </div>
    
    <audio id="alertSound" src="https://cdn.freesound.org/previews/250/250629_4486188-lq.mp3" preload="auto"></audio>
    
    <script>
        const CONFIG = {
            localidade: 'SBIZ',
            apiKey: 'f2wxxozlu1MgAZzFvFBldekAOsWs1V9R4e5546WO',
            apiUrl: 'https://api-redemet.decea.mil.br/mensagens/metar/',
            intervaloConsulta: 40000,
            tempoAlerta: 2,
            maxHistorico: 10
        };

        const elements = {
            statusValue: document.getElementById('statusValue'), statusIcon: document.getElementById('statusIcon'),
            lastCheckTime: document.getElementById('lastCheckTime'), nextCheckTime: document.getElementById('nextCheckTime'),
            countdown: document.getElementById('countdown'), metarRaw: document.getElementById('metarRaw'),
            metarTime: document.getElementById('metarTime'), alertPanel: document.getElementById('alertPanel'),
            silenceButton: document.getElementById('silenceButton'), historyContainer: document.getElementById('historyContainer'),
            volumeControl: document.getElementById('volumeControl'), autoRefresh: document.getElementById('autoRefresh'), 
            alertSound: document.getElementById('alertSound'), aerodromoInput: document.getElementById('aerodromoInput'),
            alterarAerodromo: document.getElementById('alterarAerodromo'), aerodromoHeader: document.getElementById('aerodromoHeader'),
            footerText: document.getElementById('footerText'), audioUnlockPrompt: document.getElementById('audioUnlockPrompt'),
            openAnalysisModal: document.getElementById('openAnalysisModal'), analysisModal: document.getElementById('analysisModal'),
            closeAnalysisModal: document.getElementById('closeAnalysisModal'), statsContainer: document.getElementById('statsContainer'),
            exportCsvBtn: document.getElementById('exportCsvBtn'), exportPdfBtn: document.getElementById('exportPdfBtn'),
            
            historicalAerodromoInput: document.getElementById('historicalAerodromoInput'),
            historicalDateInput: document.getElementById('historicalDateInput'),
            historicalMonthInput: document.getElementById('historicalMonthInput'),
            generateHistoricalReportBtn: document.getElementById('generateHistoricalReportBtn'),
            historicalSearchStatus: document.getElementById('historicalSearchStatus'),
            radioDiario: document.getElementById('radioDiario'),
            radioMensal: document.getElementById('radioMensal'),
            dailyInputContainer: document.getElementById('dailyInputContainer'),
            monthlyInputContainer: document.getElementById('monthlyInputContainer'),
            filterInconsistent: document.getElementById('filterInconsistent')
        };

        const state = {
            ultimoMetarCompleto: null, ultimaHoraVerificada: null, metarHoraAtualEncontrado: false,
            emAlerta: false, alarmeSilenciado: false, historicoMetar: [], consultaAtiva: true,
            intervalId: null, audioUnlocked: false, dadosRecebimento: [] 
        };

        document.addEventListener('DOMContentLoaded', inicializarApp);

        function unlockAudio() {
            if (state.audioUnlocked) return;
            elements.alertSound.play().then(() => {
                elements.alertSound.pause();
                elements.alertSound.currentTime = 0;
                state.audioUnlocked = true;
                elements.audioUnlockPrompt.style.display = 'none';
                document.querySelector('header').style.marginTop = '0';
            }).catch(e => {});
            document.removeEventListener('click', unlockAudio);
        }

        function inicializarApp() {
            carregarPreferencias();
            
            elements.silenceButton.addEventListener('click', silenciarAlarme);
            elements.volumeControl.addEventListener('input', ajustarVolume);
            elements.autoRefresh.addEventListener('change', toggleAutoRefresh); 
            elements.alterarAerodromo.addEventListener('click', alterarAerodromo);
            elements.aerodromoInput.addEventListener('keypress', e => { if (e.key === 'Enter') alterarAerodromo(); });
            
            elements.openAnalysisModal.addEventListener('click', exibirAnalise);
            elements.closeAnalysisModal.addEventListener('click', () => elements.analysisModal.classList.remove('visible'));
            elements.exportCsvBtn.addEventListener('click', exportarParaCSV);
            elements.exportPdfBtn.addEventListener('click', exportarParaPDF);

            document.addEventListener('click', unlockAudio);
            
            state.ultimaHoraVerificada = new Date().getUTCHours();
            consultarMetar(); 
            state.intervalId = setInterval(consultarMetar, CONFIG.intervaloConsulta);
            setInterval(verificarHoraCheia, 1000);
            setInterval(atualizarContagemRegressiva, 1000);
            atualizarTituloAerodromo();

            elements.historicalAerodromoInput.value = CONFIG.localidade;
            elements.historicalDateInput.valueAsDate = new Date();
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            elements.historicalMonthInput.value = `${year}-${month}`;
            
            elements.radioDiario.addEventListener('change', toggleSearchType);
            elements.radioMensal.addEventListener('change', toggleSearchType);
            elements.generateHistoricalReportBtn.addEventListener('click', iniciarBuscaHistorica);
        }
        
        function toggleSearchType() {
            if (elements.radioDiario.checked) {
                elements.dailyInputContainer.classList.remove('hidden');
                elements.monthlyInputContainer.classList.add('hidden');
            } else {
                elements.dailyInputContainer.classList.add('hidden');
                elements.monthlyInputContainer.classList.remove('hidden');
            }
        }
        
        function iniciarBuscaHistorica() {
            if (elements.radioDiario.checked) {
                buscarHistoricoDiarioEGerarPDF();
            } else {
                buscarHistoricoMensalEGerarPDF();
            }
        }

        async function buscarHistoricoDiarioEGerarPDF() {
            const icao = elements.historicalAerodromoInput.value.trim().toUpperCase();
            const date = elements.historicalDateInput.value;
            const statusEl = elements.historicalSearchStatus;
            const buttonEl = elements.generateHistoricalReportBtn;

            if (!/^[A-Z]{4}$/.test(icao) || !date) {
                statusEl.textContent = 'Erro: Verifique o ICAO e a data selecionada.';
                statusEl.style.color = 'var(--alert-color)';
                return;
            }
            
            buttonEl.disabled = true;
            statusEl.textContent = 'Buscando dados na REDEMET...';
            statusEl.style.color = 'var(--text-muted)';
            
            const data_ini = date.replace(/-/g, '') + '00';
            const data_fim = date.replace(/-/g, '') + '23';
            const url = `${CONFIG.apiUrl}${icao}?api_key=${CONFIG.apiKey}&data_ini=${data_ini}&data_fim=${data_fim}`;

            try {
                const response = await fetch(url, { cache: 'no-store' });
                const data = await response.json();
                
                if (!response.ok) throw new Error(`Erro de rede: ${response.statusText}`);
                if (!data.status && data.message && !data.message.includes("data inicial ou final")) throw new Error(data.message);

                let dadosParaRelatorio = (data.data && data.data.data && data.data.data.length > 0) ? data.data.data : [];

                if (elements.filterInconsistent.checked) {
                    dadosParaRelatorio = dadosParaRelatorio.filter(msg => isMessageInconsistent(msg));
                }
                
                if (dadosParaRelatorio.length > 0) {
                    statusEl.textContent = `Encontradas ${dadosParaRelatorio.length} mensagens. Gerando PDF...`;
                    statusEl.style.color = 'var(--success-color)';
                    gerarPDFHistorico(dadosParaRelatorio, icao, date, 'daily');
                } else {
                    const dataFormatada = new Date(date.replace(/-/g, '/')).toLocaleDateString();
                    const msgText = elements.filterInconsistent.checked 
                        ? `Nenhuma mensagem inconsistente encontrada para ${icao} na data ${dataFormatada}.`
                        : `Nenhuma mensagem encontrada para ${icao} na data ${dataFormatada}.`;
                    statusEl.textContent = msgText;
                    statusEl.style.color = 'var(--warning-color)';
                }
            } catch (error) {
                console.error("Erro na busca diária:", error);
                statusEl.textContent = `Erro ao buscar dados: ${error.message}`;
                statusEl.style.color = 'var(--alert-color)';
            } finally {
                buttonEl.disabled = false;
            }
        }
        
        async function buscarHistoricoMensalEGerarPDF() {
            const icao = elements.historicalAerodromoInput.value.trim().toUpperCase();
            const monthValue = elements.historicalMonthInput.value;
            const statusEl = elements.historicalSearchStatus;
            const buttonEl = elements.generateHistoricalReportBtn;

            if (!/^[A-Z]{4}$/.test(icao) || !monthValue) {
                statusEl.textContent = 'Erro: Verifique o ICAO e o Mês/Ano selecionado.';
                statusEl.style.color = 'var(--alert-color)';
                return;
            }
            
            buttonEl.disabled = true;
            buttonEl.textContent = 'Buscando...';

            const [year, month] = monthValue.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            let todasAsMensagens = [];

            try {
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayString = day.toString().padStart(2, '0');
                    const monthString = month.toString().padStart(2, '0');
                    const dateString = `${year}${monthString}${dayString}`;
                    
                    statusEl.textContent = `Buscando dados para o dia ${day} de ${daysInMonth}...`;
                    statusEl.style.color = 'var(--text-muted)';

                    const data_ini = dateString + '00';
                    const data_fim = dateString + '23';
                    const url = `${CONFIG.apiUrl}${icao}?api_key=${CONFIG.apiKey}&data_ini=${data_ini}&data_fim=${data_fim}`;

                    const response = await fetch(url, { cache: 'no-store' });
                    const data = await response.json();
                    
                    if (data.status && data.data && data.data.data && data.data.data.length > 0) {
                        todasAsMensagens.push(...data.data.data);
                    }
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                let dadosParaRelatorio = todasAsMensagens;
                if (elements.filterInconsistent.checked) {
                    dadosParaRelatorio = dadosParaRelatorio.filter(msg => isMessageInconsistent(msg));
                }

                if (dadosParaRelatorio.length > 0) {
                    statusEl.textContent = `Total de ${dadosParaRelatorio.length} mensagens encontradas. Gerando PDF...`;
                    statusEl.style.color = 'var(--success-color)';
                    gerarPDFHistorico(dadosParaRelatorio, icao, monthValue, 'monthly');
                } else {
                    const monthName = new Date(year, month - 1, 1).toLocaleString('pt-BR', { month: 'long' });
                    const msgText = elements.filterInconsistent.checked
                        ? `Nenhuma mensagem inconsistente encontrada para ${icao} em ${monthName} de ${year}.`
                        : `Nenhuma mensagem encontrada para ${icao} em ${monthName} de ${year}.`;
                    statusEl.textContent = msgText;
                    statusEl.style.color = 'var(--warning-color)';
                }

            } catch (error) {
                console.error("Erro na busca mensal:", error);
                statusEl.textContent = `Erro ao buscar dados: ${error.message}`;
                statusEl.style.color = 'var(--alert-color)';
            } finally {
                buttonEl.disabled = false;
                buttonEl.textContent = 'Gerar Relatório';
            }
        }
        
        function isMessageInconsistent(msgObject) {
            const mensText = msgObject.mens || '';
            const recepcaoInfo = msgObject.timestamp || msgObject.recebimento;
            if (!mensText || !recepcaoInfo) return false;

            // CORREÇÃO: Força a interpretação da string de recebimento como UTC
            const recepcaoDate = new Date((typeof recepcaoInfo === 'string' ? recepcaoInfo.replace(' ', 'T') + 'Z' : recepcaoInfo));
            if (isNaN(recepcaoDate.getTime())) return false;

            const tipo = mensText.trim().startsWith('SPECI') ? 'SPECI' : 'METAR';
            
            if (tipo === 'METAR') {
                const minutoRecepcao = recepcaoDate.getUTCMinutes();
                return minutoRecepcao >= 5 && minutoRecepcao < 55;
            }
            
            if (tipo === 'SPECI') {
                const regex = /\s(\d{2})(\d{2})(\d{2})Z\s/;
                const match = mensText.match(regex);
                if (match) {
                    const msgDay = parseInt(match[1], 10);
                    const msgHour = parseInt(match[2], 10);
                    const msgMinute = parseInt(match[3], 10);
                    
                    const msgDate = new Date(Date.UTC(recepcaoDate.getUTCFullYear(), recepcaoDate.getUTCMonth(), msgDay, msgHour, msgMinute));
                    
                    const recepcaoTruncada = new Date(recepcaoDate);
                    recepcaoTruncada.setUTCSeconds(0, 0);

                    const diffEmMinutos = (recepcaoTruncada.getTime() - msgDate.getTime()) / (1000 * 60);

                    return diffEmMinutos > 15;
                }
            }
            return false;
        }

        function gerarPDFHistorico(mensagens, icao, dateValue, type) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let title, filename;
            const isFiltered = elements.filterInconsistent.checked;

            if (type === 'daily') {
                const dataFormatada = new Date(dateValue.replace(/-/g, '/')).toLocaleDateString('pt-BR');
                title = isFiltered ? `Relatório de Inconsistências - ${icao} - ${dataFormatada}` : `Relatório Diário - ${icao} - ${dataFormatada}`;
                filename = `relatorio_${isFiltered ? 'inconsistencias' : 'diario'}_${icao}_${dateValue}.pdf`;
            } else { // monthly
                const [year, month] = dateValue.split('-');
                const monthName = new Date(year, month - 1, 1).toLocaleString('pt-BR', { month: 'long' });
                const formattedMonth = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                title = isFiltered ? `Relatório de Inconsistências - ${icao} - ${formattedMonth} de ${year}` : `Relatório Mensal - ${icao} - ${formattedMonth} de ${year}`;
                filename = `relatorio_${isFiltered ? 'inconsistencias' : 'mensal'}_${icao}_${dateValue}.pdf`;
            }
            
            doc.text(title, 14, 15);
            
            const tableColumn = ["Tipo", "Hora UTC Msg", "Data Recebimento", "Hora Recebimento"];
            
            const dadosFormatados = mensagens.map(msg => {
                const tipo = msg.mens.trim().startsWith('SPECI') ? 'SPECI' : 'METAR';
                const regex = /\s(\d{2})(\d{2})(\d{2})Z\s/;
                const match = msg.mens.match(regex);
                let horaUTC = "N/A";
                if (match) {
                    horaUTC = `${match[2]}${match[3]}Z`;
                }
                return { mens: msg.mens, recebimento: msg.recebimento, tipo: tipo, timestamp: new Date(msg.recebimento), horaUTC: horaUTC };
            }).sort((a,b) => a.timestamp - b.timestamp);

            const tableRows = dadosFormatados.map(d => [d.tipo, d.horaUTC, d.timestamp.toLocaleDateString('pt-BR'), d.timestamp.toLocaleTimeString('pt-BR')]);
            
            doc.autoTable({
                head: [tableColumn], body: tableRows, startY: 20,
                didParseCell: function(data) {
                    if (data.section === 'body') {
                        const originalData = dadosFormatados[data.row.index];
                        if (isMessageInconsistent(originalData)) {
                             data.cell.styles.textColor = [239, 68, 68];
                        }
                    }
                }
            });
            
            doc.save(filename);
            elements.historicalSearchStatus.textContent = `Relatório gerado com sucesso!`;
        }

        async function consultarMetar() {
            if (!state.consultaAtiva) return;
            atualizarStatus('Consultando...', 'warning');
            const url = `${CONFIG.apiUrl}${CONFIG.localidade}?api_key=${CONFIG.apiKey}`;
            try {
                const response = await fetch(url, { cache: 'no-store' });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || `Erro de rede: ${response.statusText}`);
                if (!data.status && data.message) throw new Error(data.message);
                if (data.data && data.data.data && data.data.data.length > 0) {
                    processarResposta(data); 
                    atualizarStatus('OK', 'normal');
                } else { 
                    elements.metarRaw.textContent = `Aguardando METAR/SPECI para ${CONFIG.localidade}...`;
                }
            } catch (error) {
                console.error(`Erro ao consultar METAR/SPECI: ${error.message}`);
                atualizarStatus('Erro', 'error');
                elements.metarRaw.textContent = `Falha ao buscar dados: ${error.message}`;
            }
        }
        
        function processarResposta(data) {
            const agora = new Date();
            elements.lastCheckTime.textContent = formatarHora(agora);
            const todasAsMensagens = data.data.data;

            if (todasAsMensagens.length > 0) {
                let msgParaExibir = todasAsMensagens.find(m => m.mens.trim().startsWith('SPECI')) || todasAsMensagens[0];
                elements.metarRaw.textContent = msgParaExibir.mens.trim();
                
                const match = msgParaExibir.mens.trim().match(/(METAR|SPECI)\s+([A-Z]{4})\s+(\d{2})(\d{2})(\d{2})Z/);
                if (match) {
                    const msgHour = parseInt(match[4], 10);
                    if (msgHour === agora.getUTCHours()) {
                        state.metarHoraAtualEncontrado = true;
                        desativarAlerta();
                    }
                }
            }

            todasAsMensagens.forEach(mensagem => {
                adicionarAoHistorico(mensagem.mens.trim(), mensagem.recebimento);
                const tipo = mensagem.mens.trim().startsWith('SPECI') ? 'SPECI' : 'METAR';
                adicionarDadoDeRecebimento(mensagem.recebimento, tipo);
            });
            atualizarHistorico();
        }

        function toggleAutoRefresh() {
            state.consultaAtiva = elements.autoRefresh.checked;
            clearInterval(state.intervalId);
            if (state.consultaAtiva) {
                state.intervalId = setInterval(consultarMetar, CONFIG.intervaloConsulta);
            }
            localStorage.setItem('autoRefresh', state.consultaAtiva);
        }
        
        function adicionarDadoDeRecebimento(timestampString, tipo) {
            const timestamp = new Date(timestampString.replace(' ', 'T') + 'Z');
            if (!state.dadosRecebimento.some(d => d.timestamp.getTime() === timestamp.getTime())) {
                state.dadosRecebimento.push({ timestamp, tipo });
                salvarDadosRecebimento();
            }
        }
        
        function salvarDadosRecebimento() { localStorage.setItem(`dadosRecebimento_${CONFIG.localidade}`, JSON.stringify(state.dadosRecebimento)); }

        function carregarDadosRecebimento() {
            const dadosSalvos = localStorage.getItem(`dadosRecebimento_${CONFIG.localidade}`);
            if (dadosSalvos) {
                state.dadosRecebimento = JSON.parse(dadosSalvos).map(d => ({ ...d, timestamp: new Date(d.timestamp) }));
            } else { state.dadosRecebimento = []; }
        }

        function exibirAnalise() {
            const total = state.dadosRecebimento.length;
            if (total === 0) {
                elements.statsContainer.innerHTML = "<p>Não há dados suficientes para análise.</p>";
                elements.analysisModal.classList.add('visible'); return;
            }

            let antecipado = 0, noPadrao = 0, foraPadrao = 0;
            state.dadosRecebimento.forEach(dado => {
                const minuto = dado.timestamp.getUTCMinutes();
                if (minuto >= 55) antecipado++;
                else if (minuto >= 0 && minuto <= 4) noPadrao++;
                else foraPadrao++;
            });

            const getPercentage = (count) => total > 0 ? ((count / total) * 100).toFixed(1) + '%' : '0%';
            elements.statsContainer.innerHTML = `
                <div class="stat-card"><h4>Antecipado (55-59)</h4><div class="value">${antecipado}</div><div class="percentage">${getPercentage(antecipado)}</div></div>
                <div class="stat-card"><h4>No Padrão (00-04)</h4><div class="value">${noPadrao}</div><div class="percentage">${getPercentage(noPadrao)}</div></div>
                <div class="stat-card"><h4>Fora do Padrão (05+)</h4><div class="value">${foraPadrao}</div><div class="percentage">${getPercentage(foraPadrao)}</div></div>
                <div class="stat-card"><h4>Total</h4><div class="value">${total}</div></div>`;
            elements.analysisModal.classList.add('visible');
        }

        function exportarParaCSV() {
            if (state.dadosRecebimento.length === 0) return alert("Não há dados para exportar.");
            let csv = "data:text/csv;charset=utf-8,Tipo,Data,Hora\n";
            state.dadosRecebimento.forEach(dado => {
                csv += `${dado.tipo},${dado.timestamp.toLocaleDateString('pt-BR')},${dado.timestamp.toLocaleTimeString('pt-BR')}\n`;
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csv));
            link.setAttribute("download", `analise_recebimento_${CONFIG.localidade}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportarParaPDF() {
            if (state.dadosRecebimento.length === 0) return alert("Não há dados para exportar.");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`Análise de Recebimento - ${CONFIG.localidade}`, 14, 15);
            const tableColumn = ["Tipo", "Data", "Hora"];
            const tableRows = state.dadosRecebimento.map(d => [ d.tipo, d.timestamp.toLocaleDateString('pt-BR'), d.timestamp.toLocaleTimeString('pt-BR') ]);
            
            doc.autoTable({
                head: [tableColumn], body: tableRows, startY: 20,
                didParseCell: function(data) {
                    if (data.section === 'body') {
                        const originalData = state.dadosRecebimento[data.row.index];
                        const minuto = originalData.timestamp.getUTCMinutes();
                        if (minuto >= 5 && minuto < 55) {
                            data.cell.styles.textColor = [239, 68, 68];
                        }
                    }
                }
            });
            doc.save(`analise_recebimento_${CONFIG.localidade}.pdf`);
        }
        
        function alterarAerodromo() {
            const novoAerodromo = elements.aerodromoInput.value.trim().toUpperCase();
            if (!/^[A-Z]{4}$/.test(novoAerodromo)) return alert('Código ICAO inválido.');
            CONFIG.localidade = novoAerodromo;
            state.historicoMetar = []; 
            elements.historyContainer.innerHTML = '<p class="no-history">Nenhum histórico disponível</p>';
            atualizarTituloAerodromo();
            desativarAlerta();
            carregarDadosRecebimento();
            consultarMetar(); 
            localStorage.setItem('aerodromo', CONFIG.localidade);
        }

        function atualizarTituloAerodromo() {
            elements.aerodromoHeader.textContent = `Aeroporto de ${CONFIG.localidade}`;
            elements.footerText.textContent = `Monitoramento de METAR/SPECI - ${CONFIG.localidade} - 2025`;
            document.title = `Monitor METAR - ${CONFIG.localidade}`;
        }
        
        function carregarPreferencias() {
            const aerodromoSalvo = localStorage.getItem('aerodromo');
            if (aerodromoSalvo) {
                CONFIG.localidade = aerodromoSalvo;
                elements.aerodromoInput.value = aerodromoSalvo;
            }
            carregarDadosRecebimento();
            const volumeSalvo = localStorage.getItem('volumeAlarme');
            if (volumeSalvo) {
                elements.volumeControl.value = volumeSalvo;
                ajustarVolume();
            }
            const autoRefreshSalvo = localStorage.getItem('autoRefresh');
            if (autoRefreshSalvo !== null) {
                elements.autoRefresh.checked = autoRefreshSalvo === 'true';
                toggleAutoRefresh();
            }
        }
        
        function ajustarVolume() {
            elements.alertSound.volume = elements.volumeControl.value;
            localStorage.setItem('volumeAlarme', elements.volumeControl.value);
        }

        function formatarHora(data) { return data.toTimeString().split(' ')[0]; }

        function atualizarContagemRegressiva() {
            const agora = new Date();
            const proximaHora = new Date(agora);
            proximaHora.setUTCHours(agora.getUTCHours() + 1, 0, 0, 0);
            const diff = proximaHora - agora;
            const minutos = Math.floor((diff / 1000 / 60) % 60);
            const segundos = Math.floor((diff / 1000) % 60);
            elements.countdown.textContent = `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;

            if (state.consultaAtiva) {
                 if (elements.lastCheckTime.textContent === '--:--:--') {
                    elements.nextCheckTime.textContent = formatarHora(new Date(agora.getTime() + CONFIG.intervaloConsulta));
                } else {
                    let [h, m, s] = elements.lastCheckTime.textContent.split(':').map(Number);
                    const ultimaData = new Date();
                    ultimaData.setHours(h, m, s);
                    const proximaData = new Date(ultimaData.getTime() + CONFIG.intervaloConsulta);
                    elements.nextCheckTime.textContent = formatarHora(proximaData);
                }
            } else {
                elements.nextCheckTime.textContent = 'Pausado';
            }
        }

        function atualizarStatus(texto, tipo) {
            elements.statusValue.textContent = texto;
            elements.statusIcon.className = `status-icon status-${tipo}`;
        }

        function adicionarAoHistorico(metar, recebimentoAPI) {
            const idMensagem = `${recebimentoAPI} ${metar}`;
            if (!state.historicoMetar.some(h => h.id === idMensagem)) { 
                state.historicoMetar.unshift({ id: idMensagem, metar, timestamp: recebimentoAPI }); 
            }
        }

        function atualizarHistorico() {
            state.historicoMetar.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            state.historicoMetar = state.historicoMetar.slice(0, CONFIG.maxHistorico);
            if (state.historicoMetar.length === 0) {
                 elements.historyContainer.innerHTML = '<p class="no-history">Nenhum histórico disponível</p>';
                 return;
            };
            elements.historyContainer.innerHTML = state.historicoMetar.map(item => `
                <div class="history-item"><div class="history-metar">${item.metar}</div><div class="history-time">Recebimento: ${item.timestamp}</div></div>`
            ).join('');
        }

        function verificarHoraCheia() {
            const agora = new Date();
            const minutos = agora.getUTCMinutes();
            const segundos = agora.getUTCSeconds();
            const horaAtual = agora.getUTCHours();
            if (minutos === 0 && segundos === 0 && state.ultimaHoraVerificada !== horaAtual) {
                state.metarHoraAtualEncontrado = false;
                state.alarmeSilenciado = false;
                state.ultimaHoraVerificada = horaAtual;
                desativarAlerta();
            }
            if (minutos >= CONFIG.tempoAlerta && !state.metarHoraAtualEncontrado && !state.emAlerta && !state.alarmeSilenciado) {
                ativarAlerta();
            }
        }

        function ativarAlerta() {
            if (!state.audioUnlocked) {
                console.warn("Alerta não pode tocar. Áudio bloqueado pelo navegador.");
                return;
            };
            state.emAlerta = true;
            elements.alertPanel.style.display = 'flex';
            elements.alertSound.play().catch(e => console.error("Erro ao tocar alarme:", e));
        }

        function desativarAlerta() {
            state.emAlerta = false;
            elements.alertPanel.style.display = 'none';
            elements.alertSound.pause();
            if(elements.alertSound.currentTime > 0) elements.alertSound.currentTime = 0;
        }

        function silenciarAlarme() {
            state.alarmeSilenciado = true;
            desativarAlerta();
        }
    </script>
</body>
</html>
